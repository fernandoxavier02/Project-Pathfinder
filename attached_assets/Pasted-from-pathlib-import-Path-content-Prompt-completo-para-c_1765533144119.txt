from pathlib import Path

content = """# Prompt completo para construir um Web App de Controle de Contratos sob IFRS 15 (com Stripe + Licenças por IP)

> Use este prompt como “brief” para um time de produto/engenharia (ou para um gerador de código) construir um web app completo.  
> Foco: **gestão de contratos e reconhecimento de receita sob IFRS 15**, com **assinatura via Stripe** e **licenciamento com 1 IP ativo por licença**.

---

## 1) Objetivo do produto

Construir um web app para:
- **Cadastrar, versionar e auditar contratos** com clientes.
- **Modelar e contabilizar IFRS 15** (modelo de 5 etapas) e gerar **relatórios/disclosures**.
- **Operar cobrança recorrente** (assinaturas) e faturamento via **Stripe Billing**.
- **Controlar acesso por licenças**: cada licença pode ser usada **em um único IP por vez**, validado no backend, com trilha de auditoria.

Fontes de requisitos IFRS 15 (referências rápidas):
- Modelo de 5 passos apresentado como: identificar contrato, obrigações de desempenho, preço da transação, alocação e reconhecimento quando satisfaz obrigações. citeturn994761934144518
- Modificações contratuais: critérios para ser contrato separado e tratamentos prospectivo/cumulative catch-up. citeturn743264460132412
- Licenças de IP: direito de **acessar** (over time) vs direito de **usar** (point in time) e critérios do B58. citeturn222064711304932
- Disclosures: desagregação de receita, saldos de contrato, obrigações remanescentes, julgamentos significativos, custos de contrato etc. citeturn916401010220234
- Ativos e passivos de contrato (conceitos e distinção com contas a receber). citeturn952295662979059
- Custos de contrato: custos incrementais de obtenção e custos para cumprir, critérios e expedientes práticos. citeturn918895075246702
- Principal vs agente (gross vs net). citeturn573657998011669

---

## 2) Escopo funcional (módulos)

### 2.1 Módulo Comercial / Contratos
- Cadastro de cliente (dados fiscais, moeda, país, dados de crédito).
- Cadastro de contrato (master) e **versões** (amendments).
- Itens/linhas do contrato (bens/serviços prometidos), datas, SLAs, termos de pagamento.
- Regras de **combinação** de contratos (mesmo cliente / partes relacionadas) e histórico de decisão.
- Gestão de **modificações contratuais** (separado vs parte do contrato existente; prospectivo vs catch-up). citeturn743264460132412

### 2.2 IFRS 15 Engine (Reconhecimento de Receita)
Implementar o motor que executa e registra, por contrato e por versão:

**Passo 1 — Identificar o contrato**
- Critérios de existência (aprovação, termos, substância comercial, probabilidade de recebimento).
- Tratamento de recebimentos antes de contrato existir (passivo/depósito, quando aplicável).

**Passo 2 — Identificar obrigações de desempenho**
- Separar bens/serviços **distintos** (capable + distinct within context).
- Suportar promessas implícitas.

**Passo 3 — Determinar preço da transação**
- Valor fixo + **consideração variável** (descontos, rebates, refunds, bônus, penalidades), com trilha de estimativa e revisões. citeturn965144994230418
- Componente de financiamento significativo (quando aplicável).
- Consideração não monetária / payable to customer.

**Passo 4 — Alocar preço da transação**
- SSP (stand-alone selling prices): tabela histórica, métodos (ajuste de mercado, custo+margin, residual).
- Alocação com descontos e variáveis atribuíveis a itens específicos quando aplicável.

**Passo 5 — Reconhecer receita**
- Over time vs point in time; método de mensuração (input/output) quando over time.
- Cronogramas de receita (revenue schedules), deferrals e reversões.
- **Ativos e passivos de contrato** (contract assets / contract liabilities) e reconciliações. citeturn952295662979059

### 2.3 Módulo de Licenças (IFRS 15 “Licensing” + Acesso ao App)
- Para contratos que envolvem licenças de IP: classificar como **right to access** (reconhece ao longo do tempo) vs **right to use** (ponto no tempo), com justificativa e evidências. citeturn222064711304932
- Suportar royalties “sales/usage-based” quando aplicável.
- Para o **acesso ao software**, implementar **licenças de uso** (ver seção 4).

### 2.4 Relatórios IFRS 15 e Compliance
Gerar relatórios (exportáveis PDF/Excel e API) alinhados ao objetivo de disclosure:
- **Receita desagregada** (por produto/serviço, região, canal, timing, moeda etc.). citeturn916401010220234
- **Saldos de contrato**: abertura/fechamento, variações e ligação com receita do período. citeturn916401010220234
- **Obrigações remanescentes (backlog)**: preço alocado a performance obligations não satisfeitas e quando espera reconhecer. citeturn916401010220234
- **Julgamentos significativos**: memórias de cálculo (over time vs point-in-time, métodos, constraint de variável etc.). citeturn916401010220234
- **Custos de contrato**: ativos, amortização, impairment e expedientes. citeturn918895075246702
- **Principal vs agente**: decisões de gross vs net por obrigação. citeturn573657998011669
- Trilha de auditoria completa (quem mudou o quê, quando, justificativa).

---

## 3) Arquitetura de referência

### 3.1 Componentes
- **Front-end**: React/Next.js (BFF opcional).
- **Back-end**: Node.js (NestJS) ou Python (FastAPI) com REST/GraphQL.
- **DB**: Postgres (schema IFRS 15 + billing + licenças).
- **Fila/Jobs**: Redis + BullMQ / Celery (reconhecimento diário, webhooks, renovação de locks de IP).
- **Storage**: S3 compatível (contratos, anexos, evidências, exports).
- **Observabilidade**: logs estruturados, métricas, tracing.
- **Auth**: OIDC (Auth0/Cognito) + RBAC.

### 3.2 Serviços internos (separáveis)
1. Contract Service
2. IFRS15 Engine Service
3. Reporting Service
4. Billing/Stripe Service
5. Licensing Service (IP lock)

---

## 4) Stripe (assinatura) — Requisitos completos

### 4.1 Estratégia de cobrança (Stripe Billing)
- Usar **Stripe Products + Prices** para planos (mensal/anual, por empresa, por licença/assento).
- Criar e gerenciar **Subscriptions** para cada tenant/cliente.
- Armazenar no seu DB:
  - `stripe_customer_id`
  - `stripe_subscription_id`
  - `stripe_price_id`
  - `subscription_status` (espelho do Stripe)
  - datas: `current_period_start`, `current_period_end`, `cancel_at_period_end`

### 4.2 Fluxo de compra (Checkout)
1. Usuário cria conta/tenant no app.
2. Front chama backend para criar `Stripe Customer` + `Checkout Session`.
3. Usuário paga no **Stripe Checkout**.
4. Stripe redireciona para “success_url”.
5. **Webhook** confirma pagamento e ativa assinatura (fonte de verdade).

Eventos de webhook recomendados (mínimo):
- `checkout.session.completed`
- `customer.subscription.created`
- `customer.subscription.updated`
- `customer.subscription.deleted`
- `invoice.paid`
- `invoice.payment_failed`

Regras:
- Webhooks com verificação de assinatura (Signing Secret).
- Processamento idempotente (idempotency keys + tabela de eventos processados).
- Em caso de `invoice.payment_failed`: colocar tenant em **grace period** e depois **suspender acesso**.

### 4.3 Portal do cliente (self-service)
- Integrar **Stripe Customer Portal** para:
  - atualizar cartão
  - trocar plano
  - cancelar
  - baixar invoices

### 4.4 Integração com IFRS 15 (ponte Billing → Revenue)
- Eventos do Stripe alimentam:
  - **fatos de cobrança** (invoice lines, proration, créditos)
  - **status de collectability** (inadimplência)
  - **cronogramas** para contratos de assinatura (tipicamente over time).
- Separar: **faturamento/caixa ≠ receita**; o motor IFRS 15 decide reconhecimento e gera lançamentos/relatórios.

---

## 5) Licenças “1 IP por vez” — Requisitos completos

### 5.1 Conceito
Cada assinatura ativa dá direito a **N licenças** (ex.: 1 por padrão; ou por assento).  
Cada licença pode estar **ativa em apenas um IP simultaneamente**.

### 5.2 Entidades (modelo de dados)
- `license`
  - `id`, `tenant_id`
  - `status` = active/suspended/revoked/expired
  - `seat_count` (opcional)
  - `current_ip` (nullable)
  - `locked_at`, `last_seen_at`
  - `grace_until` (para troca de IP ou falha temporária)
- `license_session` (auditoria)
  - `license_id`, `ip`, `user_id`, `started_at`, `ended_at`, `ended_reason`
- `license_event_log`
  - mudanças de status, revogação, override manual, etc.

### 5.3 Regras de lock e validação (backend é autoridade)
- No login (ou antes de liberar qualquer tela sensível), o app chama:
  - `POST /license/validate` com `license_key` (ou token do tenant) + IP detectado.
- Regras:
  - Se `license.status != active` → negar.
  - Se `current_ip` vazio → setar `current_ip = ip` e `locked_at = now`.
  - Se `current_ip == ip` → renovar `last_seen_at`.
  - Se `current_ip != ip`:
    - se dentro de `grace_until` (troca autorizada) → trocar IP e registrar sessão anterior como encerrada.
    - senão → negar com mensagem “licença já em uso em outro IP”.

### 5.4 Heartbeat e liberação automática
- Front envia heartbeat:
  - `POST /license/heartbeat` a cada X minutos (ex.: 2–5 min).
- Backend considera “sessão expirada” se `last_seen_at` > TTL (ex.: 10 min).
  - Ao expirar: limpa `current_ip` e registra `license_session.ended_reason = timeout`.
- Tolerância a redes:
  - Grace period configurável (ex.: 15–60 min) para mudança de IP em viagem/VPN.

### 5.5 Controles administrativos
- Tela admin:
  - ver IP atual por licença
  - “desconectar” (force release)
  - revogar licença
  - aumentar/diminuir seats (se modelo por assento)
- Auditoria: toda ação gera `license_event_log`.

### 5.6 Integração Licenças ↔ Stripe
- Quando webhook indicar assinatura **ativa** → criar/ativar licenças.
- Quando assinatura **past_due/unpaid/canceled** → suspender licenças automaticamente.
- Se plano define N licenças:
  - Atualizar `seat_count` e criar/remover licenças excedentes (com política definida).

---

## 6) Fluxos críticos ponta a ponta (checklist)

### 6.1 Onboarding + Compra
1. Signup → cria Tenant
2. Escolhe plano → backend cria Checkout Session
3. Stripe Checkout → pagamento
4. Webhook confirma → ativa assinatura + cria licenças
5. Usuário loga → `/license/validate` fixa IP

### 6.2 Uso diário
- A cada request relevante (ou a cada X minutos), validar licença (cache curto).
- Heartbeat mantém sessão ativa.
- Ao detectar TTL expirado, liberar IP.

### 6.3 Troca de IP
- Solicitação do usuário (botão “Trocar IP”):
  - cria `grace_until = now + 30min` e libera troca 1 vez.
- Ou admin “force release”.

### 6.4 Falha de pagamento
- `invoice.payment_failed`:
  - seta `grace_until` para X dias (política)
  - após expirar: `status = suspended` e bloqueia validação.

---

## 7) Requisitos de segurança e compliance
- Webhooks Stripe: assinatura verificada + idempotência.
- Rate limiting em `/license/validate` e `/heartbeat`.
- Logs de acesso e auditoria (LGPD).
- Criptografia em repouso (DB, S3) e em trânsito (TLS).
- RBAC: Finance/Admin/Auditor/Operações/Leitura.

---

## 8) APIs mínimas (exemplo)
- Billing:
  - `POST /billing/checkout-session`
  - `POST /billing/webhook` (Stripe)
  - `GET /billing/subscription`
- Licenças:
  - `POST /license/validate`
  - `POST /license/heartbeat`
  - `POST /license/release` (admin)
- IFRS:
  - `POST /contracts`
  - `POST /contracts/{id}/versions`
  - `POST /ifrs15/run/{contract_id}`
  - `GET /reports/ifrs15/disclosures`

---

## 9) Critérios de aceite (resumo)
- Assinatura Stripe cria/atualiza status no app via webhook.
- Cancelamento/inadimplência suspende acesso automaticamente.
- Cada licença funciona **em um único IP por vez**, com heartbeat e timeout.
- Motor IFRS 15 gera:
  - schedules de receita
  - saldos de contrato
  - relatórios de disclosure e trilha de julgamento
- Auditoria completa para alterações contratuais e decisões IFRS.

"""

path = Path("/mnt/data/prompt_webapp_ifrs15_stripe_licencas.md")
path.write_text(content, encoding="utf-8")
str(path)